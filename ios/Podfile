# Resolve react_native_pods.rb with node to allow for hoisting
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

platform :ios, min_ios_version_supported
prepare_react_native_project!

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
end

use_frameworks! :linkage => :static

target 'candidates_app' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )


  pod 'Firebase/Firestore'

  post_install do |installer|
    # https://github.com/facebook/react-native/blob/main/packages/react-native/scripts/react_native_pods.rb#L197-L202
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      # :ccache_enabled => true
    )

    # Fix CocoaPods-generated script phases when the project path contains spaces
    # (e.g. ".../Jeremy Nassau/..."). Without this, Xcode runs:
    #   /bin/sh -c "$WITH_ENVIRONMENT $SCRIPT_PHASES_SCRIPT"
    # which breaks into "/Users/.../Jeremy" and fails.
    installer.pods_project.targets.each do |target|
      target.build_phases.each do |phase|
        next unless phase.is_a?(Xcodeproj::Project::Object::PBXShellScriptBuildPhase)
        next unless phase.shell_script

        phase.shell_script = phase.shell_script.gsub(
          %q(/bin/sh -c "$WITH_ENVIRONMENT $SCRIPT_PHASES_SCRIPT"),
          %q("$WITH_ENVIRONMENT" "$SCRIPT_PHASES_SCRIPT")
        )
      end
    end

    installer.pods_project.save

    # Fix iOS builds failing with `non-modular-include-in-framework-module` when using frameworks.
    # This can be triggered by `use_frameworks!` (even static) across some React Native / Pods targets.
    installer.pods_project.targets.each do |t|
      t.build_configurations.each do |bc|
        bc.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'

        # Some targets add -Werror=non-modular-include-in-framework-module; remove it if present.
        ['OTHER_CFLAGS', 'OTHER_CPLUSPLUSFLAGS'].each do |k|
          v = bc.build_settings[k]
          next if v.nil?

          flags =
            if v.is_a?(String)
              v.split(' ')
            elsif v.is_a?(Array)
              v
            else
              []
            end

          flags = flags.reject { |f| f == '-Werror=non-modular-include-in-framework-module' }
          bc.build_settings[k] = v.is_a?(String) ? flags.join(' ') : flags
        end
      end
    end
  end
end
